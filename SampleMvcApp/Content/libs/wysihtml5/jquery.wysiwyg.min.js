(function(n){function Wysiwyg(n,t){return this instanceof Wysiwyg?this.init(n,t):new Wysiwyg(n,t)}n.fn.document=function(){var n=this.get(0);return n.nodeName.toLowerCase()=="iframe"?n.contentWindow.document:this},n.fn.documentSelection=function(){var n=this.get(0);return n.contentWindow.document.selection?n.contentWindow.document.selection.createRange().text:n.contentWindow.getSelection().toString()},n.fn.wysiwyg=function(t){var f,e,r,u,i;if(arguments.length>0&&arguments[0].constructor==String){for(f=arguments[0].toString(),e=[],r=1;r<arguments.length;r++)e[r-1]=arguments[r];return f in Wysiwyg?this.each(function(){n.data(this,"wysiwyg").designMode(),Wysiwyg[f].apply(this,e)}):this}u={},t&&t.controls&&(u=t.controls,delete t.controls),t=n.extend({html:'<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">STYLE_SHEET<\/head><body style="margin: 0px;">INITIAL_CONTENT<\/body><\/html>',css:{},debug:!1,autoSave:!0,rmUnwantedBr:!0,brIE:!0,controls:{},messages:{}},t),t.messages=n.extend(!0,t.messages,Wysiwyg.MSGS_EN),t.controls=n.extend(!0,t.controls,Wysiwyg.TOOLBAR);for(i in u)i in t.controls?n.extend(t.controls[i],u[i]):t.controls[i]=u[i];return this.each(function(){Wysiwyg(this,t)})},n.extend(Wysiwyg,{insertImage:function(t,i){var r=n.data(this,"wysiwyg"),u,f;if(r.constructor==Wysiwyg&&t&&t.length>0)if(n.browser.msie&&r.focus(),i){if(r.editorDoc.execCommand("insertImage",!1,"#jwysiwyg#"),u=r.getElementByAttributeValue("img","src","#jwysiwyg#"),u){u.src=t;for(f in i)u.setAttribute(f,i[f])}}else r.editorDoc.execCommand("insertImage",!1,t)},createLink:function(t){var i=n.data(this,"wysiwyg"),r;i.constructor==Wysiwyg&&t&&t.length>0&&(r=n(i.editor).documentSelection(),r.length>0?(n.browser.msie&&i.focus(),i.editorDoc.execCommand("unlink",!1,[]),i.editorDoc.execCommand("createLink",!1,t)):i.options.messages.nonSelection&&alert(i.options.messages.nonSelection))},insertHtml:function(t){var i=n.data(this,"wysiwyg"),r;i.constructor==Wysiwyg&&t&&t.length>0&&(n.browser.msie?(i.focus(),i.editorDoc.execCommand("insertImage",!1,"#jwysiwyg#"),r=i.getElementByAttributeValue("img","src","#jwysiwyg#"),r&&n(r).replaceWith(t)):i.editorDoc.execCommand("insertHTML",!1,t))},setContent:function(t){var i=n.data(this,"wysiwyg");i.setContent(t),i.saveContent()},clear:function(){var t=n.data(this,"wysiwyg");t.setContent(""),t.saveContent()},MSGS_EN:{nonSelection:"select the text you wish to link"},TOOLBAR:{bold:{visible:!0,tags:["b","strong"],css:{fontWeight:"bold"},tooltip:"Bold"},italic:{visible:!0,tags:["i","em"],css:{fontStyle:"italic"},tooltip:"Italic"},strikeThrough:{visible:!0,tags:["s","strike"],css:{textDecoration:"line-through"},tooltip:"Strike-through"},underline:{visible:!0,tags:["u"],css:{textDecoration:"underline"},tooltip:"Underline"},separator00:{visible:!0,separator:!0},justifyLeft:{visible:!0,css:{textAlign:"left"},tooltip:"Justify Left"},justifyCenter:{visible:!0,tags:["center"],css:{textAlign:"center"},tooltip:"Justify Center"},justifyRight:{visible:!0,css:{textAlign:"right"},tooltip:"Justify Right"},justifyFull:{visible:!0,css:{textAlign:"justify"},tooltip:"Justify Full"},separator01:{visible:!0,separator:!0},indent:{visible:!0,tooltip:"Indent"},outdent:{visible:!0,tooltip:"Outdent"},separator02:{visible:!1,separator:!0},subscript:{visible:!0,tags:["sub"],tooltip:"Subscript"},superscript:{visible:!0,tags:["sup"],tooltip:"Superscript"},separator03:{visible:!0,separator:!0},undo:{visible:!0,tooltip:"Undo"},redo:{visible:!0,tooltip:"Redo"},separator04:{visible:!0,separator:!0},insertOrderedList:{visible:!0,tags:["ol"],tooltip:"Insert Ordered List"},insertUnorderedList:{visible:!0,tags:["ul"],tooltip:"Insert Unordered List"},insertHorizontalRule:{visible:!0,tags:["hr"],tooltip:"Insert Horizontal Rule"},separator05:{separator:!0},createLink:{visible:!0,exec:function(){var i=n(this.editor).documentSelection(),t;i.length>0?n.browser.msie?(this.focus(),this.editorDoc.execCommand("createLink",!0,null)):(t=prompt("URL","http://"),t&&t.length>0&&(this.editorDoc.execCommand("unlink",!1,[]),this.editorDoc.execCommand("createLink",!1,t))):this.options.messages.nonSelection&&alert(this.options.messages.nonSelection)},tags:["a"],tooltip:"Create link"},insertImage:{visible:!0,exec:function(){if(n.browser.msie)this.focus(),this.editorDoc.execCommand("insertImage",!0,null);else{var t=prompt("URL","http://");t&&t.length>0&&this.editorDoc.execCommand("insertImage",!1,t)}},tags:["img"],tooltip:"Insert image"},separator06:{separator:!0},h1mozilla:{visible:!0&&n.browser.mozilla,className:"h1",command:"heading",arguments:["h1"],tags:["h1"],tooltip:"Header 1"},h2mozilla:{visible:!0&&n.browser.mozilla,className:"h2",command:"heading",arguments:["h2"],tags:["h2"],tooltip:"Header 2"},h3mozilla:{visible:!0&&n.browser.mozilla,className:"h3",command:"heading",arguments:["h3"],tags:["h3"],tooltip:"Header 3"},h1:{visible:!0&&!n.browser.mozilla,className:"h1",command:"formatBlock",arguments:["<H1>"],tags:["h1"],tooltip:"Header 1"},h2:{visible:!0&&!n.browser.mozilla,className:"h2",command:"formatBlock",arguments:["<H2>"],tags:["h2"],tooltip:"Header 2"},h3:{visible:!0&&!n.browser.mozilla,className:"h3",command:"formatBlock",arguments:["<H3>"],tags:["h3"],tooltip:"Header 3"},separator07:{visible:!1,separator:!0},cut:{visible:!1,tooltip:"Cut"},copy:{visible:!1,tooltip:"Copy"},paste:{visible:!1,tooltip:"Paste"},separator08:{separator:!1&&!n.browser.msie},increaseFontSize:{visible:!1&&!n.browser.msie,tags:["big"],tooltip:"Increase font size"},decreaseFontSize:{visible:!1&&!n.browser.msie,tags:["small"],tooltip:"Decrease font size"},separator09:{separator:!0},html:{visible:!1,exec:function(){this.viewHTML?(this.setContent(n(this.original).val()),n(this.original).hide()):(this.saveContent(),n(this.original).show()),this.viewHTML=!this.viewHTML},tooltip:"View source code"},removeFormat:{visible:!0,exec:function(){n.browser.msie&&this.focus(),this.editorDoc.execCommand("removeFormat",!1,[]),this.editorDoc.execCommand("unlink",!1,[])},tooltip:"Remove formatting"}}}),n.extend(Wysiwyg.prototype,{original:null,options:{},element:null,editor:null,focus:function(){n(this.editorDoc.body).focus()},init:function(t,i){var f=this,r,u,o,s,e;this.editor=t,this.options=i||{},n.data(t,"wysiwyg",this),r=t.width||t.clientWidth,u=t.height||t.clientHeight,t.nodeName.toLowerCase()=="textarea"&&(this.original=t,r==0&&t.cols&&(r=t.cols*8+21),u==0&&t.rows&&(u=t.rows*16+16),o=this.editor=n('<iframe src="javascript:false;"><\/iframe>').css({minHeight:(u-6).toString()+"px",width:(r-8).toString()+"px"}).attr("id",n(t).attr("id")+"IFrame").attr("frameborder","0"),this.editor.attr("tabindex",n(t).attr("tabindex")),n.browser.msie&&this.editor.css("height",u.toString()+"px")),s=this.panel=n('<ul role="menu" class="panel"><\/ul>'),this.appendControls(),this.element=n("<div><\/div>").css({width:r>0?r.toString()+"px":"100%"}).addClass("wysiwyg").append(s).append(n("<div><!-- --><\/div>").css({clear:"both"})).append(o),n(t).hide().before(this.element),this.viewHTML=!1,this.initialHeight=u-8,this.initialContent=n(t).val(),this.initFrame(),this.initialContent.length==0&&this.setContent(""),e=n(t).closest("form"),this.options.autoSave&&e.submit(function(){f.saveContent()}),e.bind("reset",function(){f.setContent(f.initialContent),f.saveContent()})},initFrame:function(){var t=this,i="";this.options.css&&this.options.css.constructor==String&&(i='<link rel="stylesheet" type="text/css" media="screen" href="'+this.options.css+'" />'),this.editorDoc=n(this.editor).document(),this.editorDoc_designMode=!1;try{this.editorDoc.designMode="on",this.editorDoc_designMode=!0}catch(r){n(this.editorDoc).focus(function(){t.designMode()})}this.editorDoc.open(),this.editorDoc.write(this.options.html.replace(/INITIAL_CONTENT/,function(){return t.initialContent}).replace(/STYLE_SHEET/,function(){return i})),this.editorDoc.close(),this.editorDoc.contentEditable="true",n.browser.msie&&setTimeout(function(){n(t.editorDoc.body).css("border","none")},0),n(this.editorDoc).click(function(n){t.checkTargets(n.target?n.target:n.srcElement)}),n(this.original).focus(function(){n.browser.msie||t.focus()}),this.options.autoSave&&n(this.editorDoc).keydown(function(){t.saveContent()}).keyup(function(){t.saveContent()}).mousedown(function(){t.saveContent()}),this.options.css&&setTimeout(function(){t.options.css.constructor==String||n(t.editorDoc).find("body").css(t.options.css)},0),n(this.editorDoc).keydown(function(i){if(n.browser.msie&&t.options.brIE&&i.keyCode==13){var r=t.getRange();return r.pasteHTML("<br />"),r.collapse(!1),r.select(),!1}return!0})},designMode:function(){if(!this.editorDoc_designMode)try{this.editorDoc.designMode="on",this.editorDoc_designMode=!0}catch(n){}},getSelection:function(){return window.getSelection?window.getSelection():document.selection},getRange:function(){var n=this.getSelection();return n?n.rangeCount>0?n.getRangeAt(0):n.createRange():null},getContent:function(){return n(n(this.editor).document()).find("body").html()},setContent:function(t){n(n(this.editor).document()).find("body").html(t)},saveContent:function(){if(this.original){var t=this.getContent();this.options.rmUnwantedBr&&(t=t.substr(-4)=="<br>"?t.substr(0,t.length-4):t),n(this.original).val(t)}},withoutCss:function(){if(n.browser.mozilla)try{this.editorDoc.execCommand("styleWithCSS",!1,!1)}catch(t){try{this.editorDoc.execCommand("useCSS",!1,!0)}catch(t){}}},appendMenu:function(t,i,r,u,f){var e=this;i=i||[],n("<li><\/li>").append(n('<a role="menuitem" tabindex="-1" href="javascript:;">'+(r||t)+"<\/a>").addClass(r||t).attr("title",f)).click(function(){u?u.apply(e):(e.withoutCss(),e.editorDoc.execCommand(t,!1,i)),e.options.autoSave&&e.saveContent()}).appendTo(this.panel)},appendMenuSeparator:function(){n('<li role="separator" class="separator"><\/li>').appendTo(this.panel)},appendControls:function(){var t,n;for(t in this.options.controls)n=this.options.controls[t],n.separator?n.visible!==!1&&this.appendMenuSeparator():n.visible&&this.appendMenu(n.command||t,n.arguments||[],n.className||n.command||t||"empty",n.exec,n.tooltip||n.command||t||"")},checkTargets:function(t){var f,r,u,i,e;for(f in this.options.controls){if(r=this.options.controls[f],u=r.className||r.command||f||"empty",n("."+u,this.panel).removeClass("active"),r.tags){i=t;do{if(i.nodeType!=1)break;n.inArray(i.tagName.toLowerCase(),r.tags)!=-1&&n("."+u,this.panel).addClass("active")}while(i=i.parentNode)}if(r.css){i=n(t);do{if(i[0].nodeType!=1)break;for(e in r.css)i.css(e).toString().toLowerCase()==r.css[e]&&n("."+u,this.panel).addClass("active")}while(i=i.parent())}}},getElementByAttributeValue:function(t,i,r){for(var e=this.editorDoc.getElementsByTagName(t),f,u=0;u<e.length;u++)if(f=e[u].getAttribute(i),n.browser.msie&&(f=f.substr(f.length-r.length)),f==r)return e[u];return!1}})})(jQuery)